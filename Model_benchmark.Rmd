---
title: "Model_benchmark"
output: html_document
date: '2023-03-27'
---


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(timetk)
library(forecast)
library(tseries)
library(lubridate)
```


```{r}
prices <- read.csv("data/price_clean.csv") %>%
  mutate(
         hour_utc = lubridate::as_datetime(hour_utc),
         hour_dk = lubridate::as_datetime(hour_dk),
         spot_price_dkk = as.numeric(spot_price_dkk))
con <- read.csv("data/con_clean.csv")
prod <- read.csv("data/prod_clean.csv")
```


```{r}
prices <- prices %>%
  arrange(hour_utc) %>%
  filter(price_area == "DK1")

con <- con %>%
  arrange(hour_utc)

prod <- prod %>%
  filter(price_area == "DK1") %>%
  arrange(hour_utc)
```

```{r}
prices["t"] <- 1:length(prices$spot_price_dkk)
prices["Hour"] <- hour(prices$hour_utc)
prices["Wday"] <- wday(prices$hour_utc, label=T)
prices["Week"] <- week(prices$hour_utc)
prices["Month"] <- month(prices$hour_utc)
prices["Year"] <- year(prices$hour_utc)

prices["Sun"] <- ifelse(prices$Wday=="Sun", 1, 0)
prices["Sat"] <- ifelse(prices$Wday=="Sat", 1, 0)
prices["Fri"] <- ifelse(prices$Wday=="Fri", 1, 0)
prices["Thu"] <- ifelse(prices$Wday=="Thu", 1, 0)
prices["Wed"] <- ifelse(prices$Wday=="Wed", 1, 0)
prices["Tue"] <- ifelse(prices$Wday=="Tue", 1, 0)
prices["Mon"] <- ifelse(prices$Wday=="Mon", 1, 0)

prices["Cutoff"] <- ifelse(prices$t >= 15000, 1, 0)

prices["Winter"] <- ifelse(prices$Month %in% c(12, 1, 2), 1, 0)
prices["Spring"] <- ifelse(prices$Month %in% c(3, 4, 5), 1, 0)
prices["Summer"] <- ifelse(prices$Month %in% c(6, 7, 8), 1, 0)
prices["Autumn"] <- ifelse(prices$Month %in% c(9, 10, 11), 1, 0)
```



```{r}
prices %>% 
  plot_time_series(
    .date_var = hour_utc,
    .value = spot_price_dkk
  )
```

(auto.arima automatisk udv√¶lgelse)
```{r}
ts_df <- prices %>% 
  select(c(hour_utc, spot_price_dkk)) %>% 
  rename(datetime = hour_utc,
         value = spot_price_dkk)

# Convert the data to a ts object
ts_data <- ts(ts_df$value, frequency = 24)
```


# ARIMA
600 timers forecast.

AR(1)
```{r}
AR1 <- arima(x=prices$spot_price_dkk, 
             order=c(1, 0, 0),
             include.mean = T)
summary(AR1)
plot(prices$spot_price_dkk, type="l", xlim=c(25000, 27500))
lines(x=26809:27408 , y=as.data.frame(forecast(AR1, h=600))[,1], col="red")

plot(prices$spot_price_dkk, type="l", col=alpha("blue", 0.5))
lines(fitted(AR1), col=alpha("red", 0.5))
```

```{r}
acf(diff(prices$spot_price_dkk, 1))
pacf(diff(prices$spot_price_dkk, 1))
```


```{r}
#plot(AR1$residuals)
aTSA::arch.test(AR1)
kpss.test(AR1$residuals)
adf.test(AR1$residuals, k=1)
acf(AR1$residuals)
pacf(AR1$residuals)
hist(AR1$residuals, breaks=50)
qqnorm(AR1$residuals)
qqline(AR1$residuals)
```

AR(1) med first differencing
```{r}
AR1 <- arima(x=prices$spot_price_dkk, 
             order=c(1, 1, 0),
             include.mean = T)
summary(AR1)
plot(prices$spot_price_dkk, type="l", xlim=c(25000, 27500))
lines(x=26809:27408 , y=as.data.frame(forecast(AR1, h=600))[,1], col="red")

plot(prices$spot_price_dkk, type="l", col=alpha("blue", 0.5))
lines(fitted(AR1), col=alpha("red", 0.5))
```

```{r}
plot(AR1$residuals)
kpss.test(AR1$residuals)
adf.test(AR1$residuals, k=1)
acf(AR1$residuals)
pacf(AR1$residuals)
hist(AR1$residuals, breaks=50)
qqnorm(AR1$residuals)
qqline(AR1$residuals)
```


AR(1) med seasonality og first differencing.
```{r}
AR1 <- arima(x=data$spot_price_dkk, 
             order=c(1, 1, 0), 
             seasonal = list(order=c(1, 1, 0), period=24))
summary(AR1)

plot(prices$spot_price_dkk, type="l", xlim=c(25000, 27500))
lines(x=26809:27408 , y=as.data.frame(forecast(AR1, h=600))[,1], col="red")

plot(prices$spot_price_dkk, type="l", col=alpha("blue", 0.5))
lines(fitted(AR1), col=alpha("red", 0.5))
```

```{r}
plot(AR1$residuals)
kpss.test(AR1$residuals)
adf.test(AR1$residuals, k=1)
acf(AR1$residuals)
pacf(AR1$residuals)
hist(AR1$residuals, breaks=50)
qqnorm(AR1$residuals)
qqline(AR1$residuals)
```


AR1 med first differencing, seasonality og inverse hyperbolsk tangens transformation
```{r}
AR1 <- arima(x=prices$spot_price_dkk, 
             order=c(1, 1, 0), 
             seasonal = list(order=c(1, 0, 0), period=24),
             transform.pars=T)

summary(AR1)
plot(prices$spot_price_dkk, type="l", xlim=c(25000, 27500))
lines(x=26809:27408 , y=as.data.frame(forecast(AR1, h=600))[,1], col="red")

plot(prices$spot_price_dkk, type="l", col=alpha("blue", 0.5))
lines(fitted(AR1), col=alpha("red", 0.5))
```

```{r}
plot(AR1$residuals)
kpss.test(AR1$residuals)
adf.test(AR1$residuals, k=1)
acf(AR1$residuals)
pacf(AR1$residuals)
hist(AR1$residuals, breaks=50)
qqnorm(AR1$residuals)
qqline(AR1$residuals)
```

SARIMA(1, 1, 0)(7, 0, 0)(24) med metode = conditional sum of squares, ellers sker der en fejl under numerisk optimering.
```{r}
fix_vec_AR <- c(NA)
fix_vec_SAR <- c(NA, NA, 0, 0, 0, 0, NA)
AR1 <- arima(x=prices$spot_price_dkk, 
             order=c(1, 1, 0), 
             fixed=c(fix_vec_AR, fix_vec_SAR), 
             seasonal = list(order=c(7, 0, 0), period=24), method = "CSS")

summary(AR1)
plot(prices$spot_price_dkk, type="l", xlim=c(25000, 27500))
lines(x=26809:27408 , y=as.data.frame(forecast(AR1, h=600))[,1], col="red")

plot(prices$spot_price_dkk, type="l", col=alpha("blue", 0.5))
lines(fitted(AR1), col=alpha("red", 0.5))
```

```{r}
plot(AR1$residuals)
kpss.test(AR1$residuals)
adf.test(AR1$residuals, k=1)
acf(AR1$residuals)
pacf(AR1$residuals)
hist(AR1$residuals, breaks=50)
qqnorm(AR1$residuals)
qqline(AR1$residuals)
```


SARIMA(24, 1, 0)(7, 0, 0)(24) med metode = conditional sum of squares, ellers sker der en fejl under numerisk optimering.
```{r}
fix_vec_AR <- c(rep(0, 23), NA)
#fix_vec_AR <- c(rep(NA, 24))
fix_vec_MA <- c()
fix_vec_SAR <- c(NA, NA, 0, 0, 0, 0, NA)
#fix_vec_SAR <- c(rep(NA, 7))
fix_vec_SMA <- c()
AR1 <- arima(x=prices$spot_price_dkk, 
             order=c(24, 1, 0), 
             fixed=c(fix_vec_AR, fix_vec_MA, fix_vec_SAR, fix_vec_SMA), 
             seasonal = list(order=c(7, 0, 0), period=24), 
             method = "CSS")

summary(AR1)
plot(prices$spot_price_dkk, type="l", xlim=c(25000, 27500))
lines(x=26809:27408 , y=as.data.frame(forecast(AR1, h=600))[,1], col="red")

plot(prices$spot_price_dkk, type="l", col=alpha("blue", 0.5))
lines(fitted(AR1), col=alpha("red", 0.5))
```

```{r}
plot(AR1$residuals)
kpss.test(AR1$residuals)
adf.test(AR1$residuals, k=1)
acf(AR1$residuals, lag.max=50)
pacf(AR1$residuals, lag.max=50)
hist(AR1$residuals, breaks=50)
qqnorm(AR1$residuals)
qqline(AR1$residuals)
```


SARIMA(1, 1, 24)(0, 0, 7)(24)
```{r}
#fix_vec_AR <- c(rep(0, 23), NA)
fix_vec_AR <- c(rep(NA, 1))
fix_vec_MA <- c(rep(NA, 24))
#fix_vec_SAR <- c(NA, NA, 0, 0, 0, 0, NA)
fix_vec_SAR <- c(rep(NA, 0))
fix_vec_SMA <- c(rep(NA, 7))
AR1 <- arima(x=prices$spot_price_dkk, 
             order=c(1, 1, 24), 
             fixed=c(fix_vec_AR, fix_vec_MA, fix_vec_SAR, fix_vec_SMA), 
             seasonal = list(order=c(0, 0, 7), period=24), 
             method = "CSS")

summary(AR1)
plot(prices$spot_price_dkk, type="l", xlim=c(25000, 27500))
lines(x=26809:27408 , y=as.data.frame(forecast(AR1, h=600))[,1], col="red")

plot(prices$spot_price_dkk, type="l", col=alpha("blue", 0.5))
lines(fitted(AR1), col=alpha("red", 0.5))
```

```{r}
plot(AR1$residuals)
kpss.test(AR1$residuals)
adf.test(AR1$residuals, k=1)
acf(AR1$residuals, lag.max=1000)
pacf(AR1$residuals, lag.max=1000)
hist(AR1$residuals, breaks=50)
qqnorm(AR1$residuals)
qqline(AR1$residuals)
```


SARIMA(24, 1, 24)(7, 0, 0)(24)
```{r}
#fix_vec_AR <- c(rep(0, 23), NA)
fix_vec_AR <- c(rep(NA, 24))
fix_vec_MA <- c(rep(NA, 24))
#fix_vec_SAR <- c(NA, NA, 0, 0, 0, 0, NA)
fix_vec_SAR <- c(rep(NA, 7))
fix_vec_SMA <- c()
AR1 <- arima(x=prices$spot_price_dkk, 
             order=c(24, 1, 24), 
             fixed=c(fix_vec_AR, fix_vec_MA, fix_vec_SAR, fix_vec_SMA), 
             seasonal = list(order=c(7, 0, 0), period=24), 
             method = "CSS")

summary(AR1)
plot(prices$spot_price_dkk, type="l", xlim=c(25000, 27500))
lines(x=26809:27408 , y=as.data.frame(forecast(AR1, h=600))[,1], col="red")

plot(prices$spot_price_dkk, type="l", col=alpha("blue", 0.5))
lines(fitted(AR1), col=alpha("red", 0.5))
```

```{r}
plot(AR1$residuals)
kpss.test(AR1$residuals)
adf.test(AR1$residuals, k=1)
acf(AR1$residuals, lag.max=1000)
pacf(AR1$residuals, lag.max=1000)
hist(AR1$residuals, breaks=50)
qqnorm(AR1$residuals)
qqline(AR1$residuals)
```

```{r}
acf(diff(prices$spot_price_dkk, 1), lag.max=500)
pacf(diff(prices$spot_price_dkk, 1), lag.max=500)
```
Pacf viser SAR(7) er fornuftigt.




# VAR

# GARCH
```{r}
library(rugarch)
garch_spec <- ugarchspec(variance.model=list(model="sGARCH",garchOrder=c(1,1)),
                         mean.model=list(armaOrder=c(1,0)))

fit_garch <- ugarchfit(spec = garch_spec, data = prices$spot_price_dkk)
fit_garch
```

```{r}
plot(as.data.frame(fitted(fit_garch))[,1], type="l")
plot(prices$spot_price_dkk - as.data.frame(fitted(fit_garch))[,1], type="l")
```


# Day-ahead forecast

```{r}
forecast_t <- seq(from=max(prices$t)+1-24*28, to=max(prices$t))

sse <- function(data, par) {
  with(data, sum((trendfn(data, par) - spot_price_dkk)^2))
}
```


## Linear trend

```{r}
trendfn <- function(data, par) {
  with(data, par[1] + par[2]*t)
}

optimum <- optim(c(1, 2), sse, data=prices[1:(nrow(subset_prices)-24*28), ])
par_result <- optimum[[1]]
optimum

prices_trend <- trendfn(prices, par_result)
forecasts <- prices_trend[forecast_t]
residuals <- forecasts - prices$spot_price_dkk[forecast_t]
RMSE <- sqrt(mean(residuals^2))
print(RMSE)

plot(prices$t, prices$spot_price_dkk, col=alpha("black", 0.5), type="l")
lines(forecast_t, forecasts, col="red", type="l")
lines(prices$t[1:min(forecast_t)], prices_trend[1:min(forecast_t)], col="blue")
```


## Sinus trend

```{r}
trendfn <- function(data, par) {
  with(data, par[1] + par[2]*t + par[3]*sin((t+par[4])/par[5]))
}

trendfn <- function(data, par) {
  with(data, par[1] + par[2]*sin((t+par[3])/par[4]))
}

subset_prices <- prices %>%
  filter(t >= 15000)
optimum <- optim(c(10000, 100, 10, 24), 
                 sse, data=subset_prices[1:(nrow(subset_prices)-24*28), ])
par_result <- optimum[[1]]
optimum

prices_trend <- trendfn(prices, par_result)
forecasts <- prices_trend[forecast_t]
residuals <- forecasts - prices$spot_price_dkk[forecast_t]
RMSE <- sqrt(mean(residuals^2))
print(RMSE)

plot(prices$t, prices$spot_price_dkk, col=alpha("black", 0.5), type="l", xlim=c(15000, 27000))
lines(forecast_t, forecasts, col="red", type="l")
lines(prices$t[1:min(forecast_t)], prices_trend[1:min(forecast_t)], col="blue")
```

```{r}
trendfn <- function(data, par) {
  with(data, par[1] 
       + par[2]*sin((t+par[3])/240) 
       + par[4]*sin((t+par[5])/480)
       + par[6]*sin((t+par[7])/720)
       + par[8]*sin((t+par[9])/960)
       + par[10]*sin((t+par[11])/1200)
       + par[12]*sin((t+par[13])/1440)
       + par[12]*sin((t+par[13])/1680))
}

subset_prices <- prices %>%
  filter(t >= 15000)
optimum <- optim(c(10000, 
                   5000, 0, 
                   2000, 24,
                   1000, 48,
                   100, 72,
                   100, 96,
                   100, 120,
                   1000, 144), sse, data=subset_prices[1:(nrow(subset_prices)-24*28), ])
par_result <- optimum[[1]]
optimum

prices_trend <- trendfn(prices, par_result)
forecasts <- prices_trend[forecast_t]
residuals <- forecasts - prices$spot_price_dkk[forecast_t]
RMSE <- sqrt(mean(residuals^2))
print(RMSE)

plot(prices$t, prices$spot_price_dkk, col=alpha("black", 0.5), type="l", xlim=c(15000, 27000))
lines(forecast_t, forecasts, col="red", type="l")
lines(prices$t[1:min(forecast_t)], prices_trend[1:min(forecast_t)], col="blue")
```


Funktion til forecast
```{r}
forecast_func <- function(days_ahead, data,
                          fix_vec_AR, d, fix_vec_MA, 
                          fix_vec_SAR, D, fix_vec_SMA,
                          Tperiod,
                          plotbool,
                          set_coefs) {
  training_data <- data[1:(length(data)-24*days_ahead)]
  validation_data <- data[(length(training_data)+1):length(data)]
  subset_training_data <- data[(length(training_data)-24*7-50):length(training_data)]
  
  forecasts <- c()
  
  start <- Sys.time()
  
  AR_f_coef <- set_coefs
  if(is.null(set_coefs)) {
    AR_f <- arima(x=training_data, 
                  order=c(length(fix_vec_AR), d, length(fix_vec_MA)), 
                  fixed = c(fix_vec_AR, fix_vec_MA, fix_vec_SAR, fix_vec_SMA),
                  seasonal = list(order=c(length(fix_vec_SAR), D, length(fix_vec_SMA)),
                                  period=Tperiod),
                  include.mean = F,
                  method="CSS")
    AR_f_coef <- AR_f$coef
  }
  
  for (i in 1:days_ahead){
    AR_f <- arima(x=subset_training_data,
                  order=c(length(fix_vec_AR), d, length(fix_vec_MA)), 
                  fixed = AR_f_coef,
                  seasonal = list(order=c(length(fix_vec_SAR), D, length(fix_vec_SMA)),
                                  period=Tperiod),
                  include.mean = F,
                  method="CSS")
    forecasts <- c(forecasts, as.data.frame(forecast(AR_f, h=24))[,1])
    subset_training_data <- c(subset_training_data, validation_data[(24*(i-1)+1):(24*i)])
  }
  end <- Sys.time()
  print(end-start)
  residuals <- validation_data-forecasts
  RMSE <- sqrt(mean(residuals^2))
  
  print(c("RMSE:", RMSE))
  if(plotbool == T) {
    plot(training_data, type="l", 
         xlim=c(length(training_data)-250, length(data)+10), ylim=c(-500, 4500),
         main="Forecasts", xlab="Time", ylab="Price")
    lines(x=(length(training_data)+1):length(data) , y=forecasts, col="blue")
    lines(x=(length(training_data)+1):length(data) , y=validation_data, col=alpha("red", 0.5))
    legend("topright", inset=0.02, legend=c("Forecast", "Data"), col=c("blue", "red"), lty=1)
  }
  return(list(forecasts, residuals, RMSE, AR_f_coef))
}
```


Funktion til forecast med eksogene variable
```{r}
forecast_func_xreg <- function(days_ahead, data, xogen,
                          fix_vec_AR, d, fix_vec_MA, 
                          fix_vec_SAR, D, fix_vec_SMA,
                          Tperiod,
                          plotbool,
                          set_coefs) {
  training_data <- data[1:(length(data)-24*days_ahead)]
  validation_data <- data[(length(training_data)+1):length(data)]
  subset_training_data <- data[(length(training_data)-24*7-50):length(training_data)]
  
  xogen_training <- xogen[1:length(training_data), ]
  xogen_validation <- xogen[(length(training_data)+1):length(data), ]
  xogen_subset <- xogen[(length(training_data)-24*7-50):length(training_data), ]
  
  forecasts <- c()
  
  start <- Sys.time()
  
  AR_f_coef <- set_coefs
  
  fix_vec_xreg <- rep(NA, ncol(xogen))
  if(is.null(set_coefs)) {
    model <- arima(x=training_data, 
                  xreg=matrix(xogen_training, ncol=ncol(xogen), byrow=F),
                  order=c(length(fix_vec_AR), d, length(fix_vec_MA)), 
                  fixed = c(fix_vec_AR, fix_vec_MA, fix_vec_SAR, fix_vec_SMA, fix_vec_xreg),
                  seasonal = list(order=c(length(fix_vec_SAR), D, length(fix_vec_SMA)),
                                  period=Tperiod),
                  include.mean = F,
                  method="CSS")
    
    AR_f <- Arima(y=training_data,
                  model=model,
                  xreg=matrix(xogen_training, ncol=ncol(xogen), byrow=F),
                  include.mean=F)
    
    AR_f_coef <- AR_f$coef
  }
  
  for (i in 1:days_ahead){
    model <- arima(x=subset_training_data,
                  xreg=matrix(xogen_subset, ncol=ncol(xogen), byrow=F),
                  order=c(length(fix_vec_AR), d, length(fix_vec_MA)), 
                  fixed=AR_f_coef,
                  seasonal=list(order=c(length(fix_vec_SAR), D, length(fix_vec_SMA)),
                                  period=Tperiod),
                  include.mean=F,
                  method="CSS")
    
    AR_f <- Arima(y=subset_training_data,
                  model=model,
                  xreg=matrix(xogen_subset, ncol=ncol(xogen), byrow=F),
                  include.mean = F)
    
    forecasts <- c(forecasts, 
                   as.data.frame(forecast(AR_f,
                                          xreg=matrix(xogen_validation[(24*(i-1)+1):(24*i), ],
                                                      ncol=ncol(xogen), byrow=F)))[,1])
    
    xogen_subset <- rbind(xogen_subset, xogen_validation[(24*(i-1)+1):(24*i), ])
    subset_training_data <- c(subset_training_data, validation_data[(24*(i-1)+1):(24*i)])
    
  }
  end <- Sys.time()
  print(end-start)
  residuals <- validation_data-forecasts
  RMSE <- sqrt(mean(residuals^2))
  
  print(c("RMSE:", RMSE))
  if(plotbool == T) {
    plot(training_data, type="l", 
         xlim=c(length(training_data)-250, length(data)+10), ylim=c(-500, 4500),
         main="Forecasts", xlab="Time", ylab="Price")
    lines(x=(length(training_data)+1):length(data) , y=forecasts, col="blue")
    lines(x=(length(training_data)+1):length(data) , y=validation_data, col=alpha("red", 0.5))
    legend("topright", inset=0.02, legend=c("Forecast", "Data"), col=c("blue", "red"), lty=1)
  }
  return(list(forecasts, residuals, RMSE, AR_f_coef))
}
```


## ARIMA(1, 1, 0)(0, 0, 0)(24)
```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk,
                            c(NA), 1, c(), 
                            c(), 0, c(), 
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```

## ARIMA(24, 1, 0)(0, 0, 0)(0)
```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk, 
                            c(rep(0, 23), NA), 1, c(), 
                            c(), 0, c(), 
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```

```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk, 
                            c(rep(NA, 24)), 1, c(), 
                            c(), 0, c(), 
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


## SARIMA(24, 1, 0)(7, 0, 0)(24)
```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk, 
                            c(rep(0, 23), NA), 1, c(), 
                            c(NA, NA, 0, 0, 0, 0, NA), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```

```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk, 
                            c(rep(NA, 24)), 1, c(), 
                            c(rep(NA, 7)), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


## SARIMA(1, 1, 0)(7, 0, 0)(24)
```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk,  
                            c(NA), 1, c(), 
                            c(NA, NA, 0, 0, 0, 0, NA), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```

```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk,  
                            c(NA), 1, c(), 
                            c(rep(NA, 7)), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```

## SARIMA(24, 1, 0)(7, 1, 0)(24)
```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk,  
                            c(rep(NA, 24)), 1, c(), 
                            c(rep(NA, 7)), 1, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


## SARIMA(24, 1, 1)(7, 0, 0)(24)
```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk,  
                            c(rep(NA, 24)), 1, c(NA), 
                            c(rep(NA, 7)), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```

```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk,  
                            c(rep(0, 23), NA), 1, c(NA), 
                            c(rep(NA, 7)), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```

```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk,  
                            c(rep(0, 23), NA), 1, c(NA), 
                            c(NA, NA, 0, 0, 0, 0, NA), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```

## SARIMA(24, 1, 1)(7, 0, 1)(24)
```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk,  
                            c(rep(NA, 24)), 1, c(NA), 
                            c(rep(NA, 7)), 0, c(NA),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk,  
                            c(rep(0, 23), NA), 1, c(NA), 
                            c(rep(NA, 7)), 0, c(NA),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk,  
                            c(rep(NA, 24)), 1, c(NA), 
                            c(NA, NA, 0, 0, 0, 0, NA), 0, c(NA),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk,  
                            c(rep(NA, 23), NA), 1, c(NA), 
                            c(NA, NA, 0, 0, 0, 0, NA), 0, c(NA),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


## SARIMA(24, 1, 24)(7, 0, 0)(24)
```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk,  
                            c(rep(NA, 24)), 1, c(rep(NA, 24)), 
                            c(rep(NA, 7)), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


## SARIMA(24, 1, 24)(7, 0, 7)(24)
```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk,  
                            c(rep(NA, 24)), 1, c(rep(NA, 24)), 
                            c(rep(NA, 7)), 0, c(rep(NA, 7)),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```

## ARIMA(24, 1, 0)(0, 0, 0)(0) + Weekend
```{r}
xregs <- cbind(prices$Sat, prices$Sun)

outputlist <- forecast_func_xreg(28, prices$spot_price_dkk, xregs, 
                            c(rep(NA, 24)), 1, c(), 
                            c(), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


## ARIMA(24, 1, 0)(0, 0, 0)(0) + Week day
```{r}
xregs <- cbind(prices$Tue, prices$Wed, prices$Thu, prices$Fri, prices$Sat, prices$Sun)

outputlist <- forecast_func_xreg(28, prices$spot_price_dkk, xregs, 
                            c(rep(NA, 24)), 1, c(), 
                            c(), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


## ARIMA(24, 1, 0)(0, 0, 0)(0) + seasons + weekend
```{r}
xregs <- cbind(prices$Summer, prices$Winter, prices$Spring, prices$Sat, prices$Sun)

outputlist <- forecast_func_xreg(28, prices$spot_price_dkk, xregs, 
                            c(rep(NA, 24)), 1, c(), 
                            c(), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


## ARIMA(24, 1, 0)(0, 0, 0)(0) + weekend + wind
```{r}
xregs <- cbind(prices$Sat, prices$Sun, 
               prod$onshore_wind_power, prod$offshore_wind_power)

outputlist <- forecast_func_xreg(28, prices$spot_price_dkk, xregs, 
                            c(rep(NA, 24)), 1, c(), 
                            c(), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


## ARIMA(24, 1, 0)(0, 0, 0)(0) + weekend + solar
```{r}
xregs <- cbind(prices$Sat, prices$Sun, 
               prod$onshore_wind_power, prod$offshore_wind_power,
               prod$solar_power)

outputlist <- forecast_func_xreg(28, prices$spot_price_dkk, xregs, 
                            c(rep(NA, 24)), 1, c(), 
                            c(), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


## ARIMA(24, 1, 0)(0, 0, 0)(0) + weekend + fossile
```{r}
xregs <- cbind(prices$Sat, prices$Sun, 
              prod$fossil_gas, prod$fossil_oil, prod$fossil_hard_coal)

outputlist <- forecast_func_xreg(28, prices$spot_price_dkk, xregs, 
                            c(rep(NA, 24)), 1, c(), 
                            c(), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


## ARIMA(24, 1, 0)(0, 0, 0)(0) + weekend + fossile + wind
```{r}
xregs <- cbind(prices$Sat, prices$Sun, 
              prod$fossil_gas, prod$fossil_oil, prod$fossil_hard_coal,
              prod$onshore_wind_power, prod$offshore_wind_power)

outputlist <- forecast_func_xreg(28, prices$spot_price_dkk, xregs, 
                            c(rep(NA, 24)), 1, c(), 
                            c(), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


## ARIMA(24, 1, 0)(0, 0, 0)(0) + weekend + wind + fossile + consumption
```{r}
xregs <- cbind(prices$Sat, prices$Sun, 
              prod$fossil_gas, prod$fossil_oil, prod$fossil_hard_coal,
              prod$onshore_wind_power, prod$offshore_wind_power,
              prod$total_load)

outputlist <- forecast_func_xreg(28, prices$spot_price_dkk, xregs, 
                            c(rep(NA, 24)), 1, c(), 
                            c(), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


## ARIMA(24, 1, 0)(0, 0, 0)(0) + weekend + wind + fossile + biomass
```{r}
xregs <- cbind(prices$Sat, prices$Sun, 
              prod$fossil_gas, prod$fossil_oil, prod$fossil_hard_coal,
              prod$onshore_wind_power, prod$offshore_wind_power,
              prod$biomass)

outputlist <- forecast_func_xreg(28, prices$spot_price_dkk, xregs, 
                            c(rep(NA, 24)), 1, c(), 
                            c(), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


## ARIMA(24, 1, 0)(0, 0, 0)(0) + weekend + wind + fossile + biomass + waste
```{r}
xregs <- cbind(prices$Sat, prices$Sun, 
              prod$fossil_gas, prod$fossil_oil, prod$fossil_hard_coal,
              prod$onshore_wind_power, prod$offshore_wind_power,
              prod$biomass, prod$waste)

outputlist <- forecast_func_xreg(28, prices$spot_price_dkk, xregs, 
                            c(rep(NA, 24)), 1, c(), 
                            c(), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


## ARIMA(24, 1, 0)(0, 0, 0)(0) + weekend + wind + fossile + biomass + waste + exchange
```{r}
xregs <- cbind(prices$Sat, prices$Sun, 
              prod$fossil_gas, prod$fossil_oil, prod$fossil_hard_coal,
              prod$onshore_wind_power, prod$offshore_wind_power,
              prod$biomass, prod$waste,
              prod$exchange_great_belt, prod$exchange_nordic_countries, prod$exchange_continent)

outputlist <- forecast_func_xreg(28, prices$spot_price_dkk, xregs, 
                            c(rep(NA, 24)), 1, c(), 
                            c(), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


## ARIMA(1, 1, 0)(0, 0, 0)(0) + weekend + wind + fossile + biomass + waste + exchange
```{r}
xregs <- cbind(prices$Sat, prices$Sun, 
              prod$fossil_gas, prod$fossil_oil, prod$fossil_hard_coal,
              prod$onshore_wind_power, prod$offshore_wind_power,
              prod$biomass, prod$waste,
              prod$exchange_great_belt, prod$exchange_nordic_countries, prod$exchange_continent)

outputlist <- forecast_func_xreg(28, prices$spot_price_dkk, xregs, 
                            c(NA), 1, c(), 
                            c(), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


## ARIMA(24, 1, 0)(7, 0, 0)(24) + weekend + wind + fossile + biomass + waste + exchange
```{r}
xregs <- cbind(prices$Sat, prices$Sun, 
              prod$fossil_gas, prod$fossil_oil, prod$fossil_hard_coal,
              prod$onshore_wind_power, prod$offshore_wind_power,
              prod$biomass, prod$waste,
              prod$exchange_great_belt, prod$exchange_nordic_countries, prod$exchange_continent)

outputlist <- forecast_func_xreg(28, prices$spot_price_dkk, xregs, 
                            c(rep(0, 23), NA), 1, c(), 
                            c(NA, NA, 0, 0, 0, 0, NA), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


## ARIMA(24, 1, 1)(7, 0, 1)(24) + weekend + wind + fossile + biomass + waste + exchange
```{r}
xregs <- cbind(prices$Sat, prices$Sun, 
              prod$fossil_gas, prod$fossil_oil, prod$fossil_hard_coal,
              prod$onshore_wind_power, prod$offshore_wind_power,
              prod$biomass, prod$waste,
              prod$exchange_great_belt, prod$exchange_nordic_countries, prod$exchange_continent)

outputlist <- forecast_func_xreg(28, prices$spot_price_dkk, xregs, 
                            c(rep(NA, 24)), 1, c(NA), 
                            c(rep(NA, 7)), 0, c(NA),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


# Cross validation

```{r}
prices$subset <- ifelse(prices$t >= 15000 & prices$t < 15000+3667, 1, 
                        ifelse(prices$t >= 15000+3667 & prices$t < 15000+3667*2, 2,
                               ifelse(prices$t >= 15000+3667*2 & prices$t < 15000+3667*3, 3, 0)))

prod$subset <- prices$subset
```

## ARIMA(24, 1, 0)
```{r}
RMSE_cv <- c()
for(i in 1:4) {
  if(i <= 3) {
    prices_subset <- prices[prices$subset==i, ]
  }
  if(i == 4) {
    prices_subset <- prices %>%
      filter(t >= 15000 & t <= 26808)
  }
  outputlist <- forecast_func(28, prices_subset$spot_price_dkk,  
                              c(rep(NA, 24)), 1, c(), 
                              c(), 0, c(),
                              24,
                              plotbool=F,
                              set_coefs=NULL)
  RMSE_cv <- c(RMSE_cv, outputlist[[3]])
}
print(mean(RMSE_cv))
print(sd(RMSE_cv))
print(RMSE_cv)
```

## ARIMA(24, 1, 1)(7, 0, 1)(24)
```{r}
RMSE_cv <- c()
for(i in 1:4) {
  if(i <= 3) {
    prices_subset <- prices[prices$subset==i, ]
  }
  if(i == 4) {
    prices_subset <- prices %>%
      filter(t >= 15000 & t <= 26808)
  }
  outputlist <- forecast_func(28, prices_subset$spot_price_dkk,  
                              c(rep(NA, 24)), 1, c(NA), 
                              c(rep(NA, 7)), 0, c(NA),
                              24,
                              plotbool=F,
                              set_coefs=NULL)
  RMSE_cv <- c(RMSE_cv, outputlist[[3]])
}
print(mean(RMSE_cv))
print(sd(RMSE_cv))
print(RMSE_cv)
```

## ARIMA(24, 1, 0) + weekend + wind
```{r}
RMSE_cv <- c()
for(i in 1:4) {
  if(i <= 3) {
    prices_subset <- prices[prices$subset==i, ]
    prod_subset <- prod[prod$subset==i, ]
  }
  if(i == 4) {
    prices_subset <- prices %>%
      filter(t >= 15000 & t <= 26808)
    prod_subset <- prod[prod$hour_utc == prices_subset$hour_utc]
  }
  xregs <- cbind(prices_subset$Sat, prices_subset$Sun, 
               prod_subset$onshore_wind_power, prod_subset$offshore_wind_power)

  outputlist <- forecast_func_xreg(28, prices_subset$spot_price_dkk, xregs, 
                              c(rep(NA, 24)), 1, c(), 
                              c(), 0, c(),
                              24,
                              plotbool=F,
                              set_coefs=NULL)
  RMSE_cv <- c(RMSE_cv, outputlist[[3]])
}
print(mean(RMSE_cv))
print(sd(RMSE_cv))
print(RMSE_cv)
```

## ARIMA(24, 1, 0) + weekend + fossil + wind + bio + waste + exchange
```{r}
RMSE_cv <- c()
for(i in 1:4) {
  if(i <= 3) {
    prices_subset <- prices[prices$subset==i, ]
    prod_subset <- prod[prod$subset==i, ]
  }
  if(i == 4) {
    prices_subset <- prices %>%
      filter(t >= 15000 & t <= 26808)
    prod_subset <- prod[prod$hour_utc == prices_subset$hour_utc]
  }
  
  xregs <- cbind(prices_subset$Sat, prices_subset$Sun, 
                prod_subset$fossil_gas, prod_subset$fossil_oil, prod_subset$fossil_hard_coal,
                prod_subset$onshore_wind_power, prod_subset$offshore_wind_power,
                prod_subset$biomass, prod_subset$waste,
                prod_subset$exchange_great_belt, prod_subset$exchange_nordic_countries, prod_subset$exchange_continent)

  outputlist <- forecast_func_xreg(28, prices_subset$spot_price_dkk, xregs, 
                              c(rep(NA, 24)), 1, c(), 
                              c(), 0, c(),
                              24,
                              plotbool=F,
                              set_coefs=NULL)
  RMSE_cv <- c(RMSE_cv, outputlist[[3]])
}
print(mean(RMSE_cv))
print(sd(RMSE_cv))
print(RMSE_cv)
```


## ARIMA(24, 1, 1)(7, 0, 1)(24) + weekend + fossil + wind + bio + waste + exchange
```{r}
RMSE_cv <- c()
for(i in 1:4) {
  if(i <= 3) {
    prices_subset <- prices[prices$subset==i, ]
    prod_subset <- prod[prod$subset==i, ]
  }
  if(i == 4) {
    prices_subset <- prices %>%
      filter(t >= 15000 & t <= 26808)
    prod_subset <- prod[prod$hour_utc == prices_subset$hour_utc]
  }
  
  xregs <- cbind(prices_subset$Sat, prices_subset$Sun, 
                prod_subset$fossil_gas, prod_subset$fossil_oil, prod_subset$fossil_hard_coal,
                prod_subset$onshore_wind_power, prod_subset$offshore_wind_power,
                prod_subset$biomass, prod_subset$waste,
                prod_subset$exchange_great_belt, prod_subset$exchange_nordic_countries, prod_subset$exchange_continent)

  outputlist <- forecast_func_xreg(28, prices_subset$spot_price_dkk, xregs, 
                              c(rep(NA, 24)), 1, c(NA), 
                              c(rep(NA, 7)), 0, c(NA),
                              24,
                              plotbool=F,
                              set_coefs=NULL)
  RMSE_cv <- c(RMSE_cv, outputlist[[3]])
}
print(mean(RMSE_cv))
print(sd(RMSE_cv))
print(RMSE_cv)
```


# Auto arima
```{r}
autofit <- auto.arima(prices$spot_price_dkk[1:(nrow(prices)-24*28)], max.p=24, max.q=24, max.P=7, max.Q=7)
summary(autofit)
```

```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk, 
                            c(NA, NA), 1, c(NA, NA), 
                            c(), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=autofit$coef)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```

Same but with exogenous variables.
```{r}
xregs <- cbind(prices$Sat, prices$Sun, 
              prod$fossil_gas, prod$fossil_oil, prod$fossil_hard_coal,
              prod$onshore_wind_power, prod$offshore_wind_power,
              prod$biomass, prod$waste,
              prod$exchange_great_belt, prod$exchange_nordic_countries, prod$exchange_continent)

autofit <- auto.arima(prices$spot_price_dkk[1:(nrow(prices)-24*28)], max.p=24, max.q=24, max.P=7, max.Q=7, xreg=xregs[1:(nrow(prices)-24*28), ], allowdrift=F)
summary(autofit)
```

```{r}
outputlist <- forecast_func_xreg(28, prices$spot_price_dkk, xregs, 
                            c(NA, NA), 1, c(NA, NA, NA), 
                            c(), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=autofit$coef)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


Auto arima with initial model being our best model.
```{r}
autofit <- auto.arima(prices$spot_price_dkk[1:(nrow(prices)-24*28)], max.p=24, max.q=24, max.P=7, max.Q=7, start.p=24, start.q=1, start.P=7, start.Q=1)
summary(autofit)
```


```{r}
outputlist <- forecast_func(28, prices$spot_price_dkk, 
                            c(rep(NA, 23)), 1, c(), 
                            c(), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=autofit$coef)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```



```{r}
xregs <- cbind(prices$Sat, prices$Sun, 
              prod$fossil_gas, prod$fossil_oil, prod$fossil_hard_coal,
              prod$onshore_wind_power, prod$offshore_wind_power,
              prod$biomass, prod$waste,
              prod$exchange_great_belt, prod$exchange_nordic_countries, prod$exchange_continent)

autofit <- auto.arima(prices$spot_price_dkk[1:(nrow(prices)-24*28)], max.p=24, max.q=24, max.P=7, max.Q=7, start.p=24, start.q=1, start.P=7, start.Q=1, xreg=xregs[1:(nrow(prices)-24*28), ])
summary(autofit)
```


```{r}
outputlist <- forecast_func_xreg(28, prices$spot_price_dkk, xregs, 
                            c(rep(NA, 23)), 1, c(), 
                            c(), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=autofit$coef)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


```{r}
xregs <- cbind(prices$Sat, prices$Sun, 
              prod$fossil_gas, prod$fossil_oil, prod$fossil_hard_coal,
              prod$onshore_wind_power, prod$offshore_wind_power,
              prod$biomass, prod$waste,
              prod$exchange_great_belt, prod$exchange_nordic_countries, prod$exchange_continent)

outputlist <- forecast_func_xreg(28, prices$spot_price_dkk, xregs, 
                            c(rep(NA, 23)), 1, c(), 
                            c(), 0, c(),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
```


## Auto Arima Cross Validation
ARIMA(23, 1, 0) + weekend + fossil + wind + bio + waste + exchange
```{r}
RMSE_cv <- c()
for(i in 1:4) {
  if(i <= 3) {
    prices_subset <- prices[prices$subset==i, ]
    prod_subset <- prod[prod$subset==i, ]
  }
  if(i == 4) {
    prices_subset <- prices %>%
      filter(t >= 15000 & t <= 26808)
    prod_subset <- prod[prod$hour_utc == prices_subset$hour_utc]
  }
  
  xregs <- cbind(prices_subset$Sat, prices_subset$Sun, 
                prod_subset$fossil_gas, prod_subset$fossil_oil, prod_subset$fossil_hard_coal,
                prod_subset$onshore_wind_power, prod_subset$offshore_wind_power,
                prod_subset$biomass, prod_subset$waste,
                prod_subset$exchange_great_belt, prod_subset$exchange_nordic_countries, prod_subset$exchange_continent)

  outputlist <- forecast_func_xreg(28, prices_subset$spot_price_dkk, xregs, 
                              c(rep(NA, 23)), 1, c(), 
                              c(), 0, c(),
                              24,
                              plotbool=F,
                              set_coefs=NULL)
  RMSE_cv <- c(RMSE_cv, outputlist[[3]])
}
print(mean(RMSE_cv))
print(sd(RMSE_cv))
print(RMSE_cv)
```


# Test data
```{r}
test_prices <- read.csv("data/test_price_clean.csv") %>%
  mutate(
    hour_utc = lubridate::as_datetime(hour_utc),
    hour_dk = lubridate::as_datetime(hour_dk),
    spot_price_dkk = as.numeric(spot_price_dkk))
test_con <- read.csv("data/test_con_clean.csv")
test_prod <- read.csv("data/test_prod_clean.csv")
```

```{r}
test_prices <- test_prices %>%
  arrange(hour_utc) %>%
  filter(price_area == "DK1")

test_con <- test_con %>%
  arrange(hour_utc)

test_prod <- test_prod %>%
  filter(price_area == "DK1") %>%
  arrange(hour_utc)
```

```{r}
test_prices["t"] <- length(prices$spot_price_dkk) + 1:length(test_prices$spot_price_dkk)
test_prices["Hour"] <- hour(test_prices$hour_utc)
test_prices["Wday"] <- wday(test_prices$hour_utc, label=T)
test_prices["Week"] <- week(test_prices$hour_utc)
test_prices["Month"] <- month(test_prices$hour_utc)
test_prices["Year"] <- year(test_prices$hour_utc)

test_prices["Sun"] <- ifelse(test_prices$Wday=="Sun", 1, 0)
test_prices["Sat"] <- ifelse(test_prices$Wday=="Sat", 1, 0)
test_prices["Fri"] <- ifelse(test_prices$Wday=="Fri", 1, 0)
test_prices["Thu"] <- ifelse(test_prices$Wday=="Thu", 1, 0)
test_prices["Wed"] <- ifelse(test_prices$Wday=="Wed", 1, 0)
test_prices["Tue"] <- ifelse(test_prices$Wday=="Tue", 1, 0)
test_prices["Mon"] <- ifelse(test_prices$Wday=="Mon", 1, 0)

test_prices["Cutoff"] <- ifelse(test_prices$t >= 15000, 1, 0)

test_prices["Winter"] <- ifelse(test_prices$Month %in% c(12, 1, 2), 1, 0)
test_prices["Spring"] <- ifelse(test_prices$Month %in% c(3, 4, 5), 1, 0)
test_prices["Summer"] <- ifelse(test_prices$Month %in% c(6, 7, 8), 1, 0)
test_prices["Autumn"] <- ifelse(test_prices$Month %in% c(9, 10, 11), 1, 0)
```


## ARIMA(24, 1, 1)(7, 0, 1)(24) + weekend + wind + fossile + biomass + waste + exchange
Day-ahead forecast of 28 days
```{r}
full_prices <- rbind(prices, test_prices[1:(24*28), ])
full_prod <- rbind(prod, test_prod[1:(24*28), ])

xregs <- cbind(full_prices$Sat, full_prices$Sun, 
              full_prod$fossil_gas, full_prod$fossil_oil, full_prod$fossil_hard_coal,
              full_prod$onshore_wind_power, full_prod$offshore_wind_power,
              full_prod$biomass, full_prod$waste,
              full_prod$exchange_great_belt, full_prod$exchange_nordic_countries, full_prod$exchange_continent)

outputlist <- forecast_func_xreg(28, full_prices$spot_price_dkk, xregs, 
                            c(rep(NA, 24)), 1, c(NA), 
                            c(rep(NA, 7)), 0, c(NA),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```


Day-ahead forecast of 59 days
```{r}
full_prices <- rbind(prices, test_prices[1:(24*59), ])
full_prod <- rbind(prod, test_prod[1:(24*59), ])

xregs <- cbind(full_prices$Sat, full_prices$Sun, 
              full_prod$fossil_gas, full_prod$fossil_oil, full_prod$fossil_hard_coal,
              full_prod$onshore_wind_power, full_prod$offshore_wind_power,
              full_prod$biomass, full_prod$waste,
              full_prod$exchange_great_belt, full_prod$exchange_nordic_countries, full_prod$exchange_continent)

outputlist <- forecast_func_xreg(59, full_prices$spot_price_dkk, xregs, 
                            c(rep(NA, 24)), 1, c(NA), 
                            c(rep(NA, 7)), 0, c(NA),
                            24,
                            plotbool=T,
                            set_coefs=NULL)
forecasts <- outputlist[[1]]
residuals <- outputlist[[2]]
RMSE <- outputlist[[3]]
AR_f_coef <- outputlist[[4]]
print(AR_f_coef)

plot(residuals, type="l")
kpss.test(residuals)
adf.test(residuals, k=1)
hist(residuals, breaks=50)
qqnorm(residuals)
qqline(residuals)
```













